<!DOCTYPE HTML>
<html lang="en" class="sidebar-visible no-js light">
    <head>
        <!-- Book generated using mdBook -->
        <meta charset="UTF-8">
        <title>Monitors - Notes</title>
        

        <meta content="text/html; charset=utf-8" http-equiv="Content-Type">
        <meta name="description" content="">
        <meta name="viewport" content="width=device-width, initial-scale=1">
        <meta name="theme-color" content="#ffffff" />

        <link rel="shortcut icon" href="../favicon.png">
        <link rel="stylesheet" href="../css/variables.css">
        <link rel="stylesheet" href="../css/general.css">
        <link rel="stylesheet" href="../css/chrome.css">
        <link rel="stylesheet" href="../css/print.css" media="print">

        <!-- Fonts -->
        <link rel="stylesheet" href="../FontAwesome/css/font-awesome.css">
        <link href="https://fonts.googleapis.com/css?family=Open+Sans:300italic,400italic,600italic,700italic,800italic,400,300,600,700,800" rel="stylesheet" type="text/css">
        <link href="https://fonts.googleapis.com/css?family=Source+Code+Pro:500" rel="stylesheet" type="text/css">

        <!-- Highlight.js Stylesheets -->
        <link rel="stylesheet" href="../highlight.css">
        <link rel="stylesheet" href="../tomorrow-night.css">
        <link rel="stylesheet" href="../ayu-highlight.css">

        <!-- Custom theme stylesheets -->
        

        
        <!-- MathJax -->
        <script async type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.1/MathJax.js?config=TeX-AMS-MML_HTMLorMML"></script>
        
    </head>
    <body>
        <!-- Provide site root to javascript -->
        <script type="text/javascript">
            var path_to_root = "../";
            var default_theme = window.matchMedia("(prefers-color-scheme: dark)").matches ? "light" : "light";
        </script>

        <!-- Work around some values being stored in localStorage wrapped in quotes -->
        <script type="text/javascript">
            try {
                var theme = localStorage.getItem('mdbook-theme');
                var sidebar = localStorage.getItem('mdbook-sidebar');

                if (theme.startsWith('"') && theme.endsWith('"')) {
                    localStorage.setItem('mdbook-theme', theme.slice(1, theme.length - 1));
                }

                if (sidebar.startsWith('"') && sidebar.endsWith('"')) {
                    localStorage.setItem('mdbook-sidebar', sidebar.slice(1, sidebar.length - 1));
                }
            } catch (e) { }
        </script>

        <!-- Set the theme before any content is loaded, prevents flash -->
        <script type="text/javascript">
            var theme;
            try { theme = localStorage.getItem('mdbook-theme'); } catch(e) { }
            if (theme === null || theme === undefined) { theme = default_theme; }
            var html = document.querySelector('html');
            html.classList.remove('no-js')
            html.classList.remove('light')
            html.classList.add(theme);
            html.classList.add('js');
        </script>

        <!-- Hide / unhide sidebar before it is displayed -->
        <script type="text/javascript">
            var html = document.querySelector('html');
            var sidebar = 'hidden';
            if (document.body.clientWidth >= 1080) {
                try { sidebar = localStorage.getItem('mdbook-sidebar'); } catch(e) { }
                sidebar = sidebar || 'visible';
            }
            html.classList.remove('sidebar-visible');
            html.classList.add("sidebar-" + sidebar);
        </script>

        <nav id="sidebar" class="sidebar" aria-label="Table of contents">
            <div id="sidebar-scrollbox" class="sidebar-scrollbox">
                <ol class="chapter"><li class="expanded "><a href="../psya02/index.html"><strong aria-hidden="true">1.</strong> PSYA02 Introduction to Psychological Science II</a></li><li><ol class="section"><li class="expanded "><a href="../psya02/01-lecture.html"><strong aria-hidden="true">1.1.</strong> Syllabus and Introduction to the Course</a></li><li class="expanded "><a href="../psya02/02-lecture.html"><strong aria-hidden="true">1.2.</strong> Personality Psychology</a></li><li class="expanded "><a href="../psya02/03-lecture.html"><strong aria-hidden="true">1.3.</strong> Personality Psychology (Part 2)</a></li><li class="expanded "><a href="../psya02/04-lecture.html"><strong aria-hidden="true">1.4.</strong> Developmental Psychology</a></li><li class="expanded "><a href="../psya02/05-lecture.html"><strong aria-hidden="true">1.5.</strong> Developmental Psychology (Part 2)</a></li><li class="expanded "><a href="../psya02/06-lecture.html"><strong aria-hidden="true">1.6.</strong> Developmental Psychology (Part 3)</a></li><li class="expanded "><a href="../psya02/07-lecture.html"><strong aria-hidden="true">1.7.</strong> Intelligence</a></li><li class="expanded "><a href="../psya02/08-lecture.html"><strong aria-hidden="true">1.8.</strong> Guest Lecture AA&amp;CC</a></li><li class="expanded "><a href="../psya02/09-lecture.html"><strong aria-hidden="true">1.9.</strong> Intelligence (Part 2)</a></li><li class="expanded "><a href="../psya02/10-lecture.html"><strong aria-hidden="true">1.10.</strong> Emotion</a></li><li class="expanded "><a href="../psya02/11-lecture.html"><strong aria-hidden="true">1.11.</strong> Emotion (Part 2)</a></li><li class="expanded "><a href="../psya02/12-lecture.html"><strong aria-hidden="true">1.12.</strong> Social Psychology</a></li><li class="expanded "><a href="../psya02/13-lecture.html"><strong aria-hidden="true">1.13.</strong> Social Psychology (Part 2)</a></li><li class="expanded "><a href="../psya02/14-lecture.html"><strong aria-hidden="true">1.14.</strong> Social Psychology (Part 3)</a></li><li class="expanded "><a href="../psya02/15-lecture.html"><strong aria-hidden="true">1.15.</strong> Health Psychology</a></li><li class="expanded "><a href="../psya02/16-lecture.html"><strong aria-hidden="true">1.16.</strong> Health Psychology (Part 2)</a></li><li class="expanded "><a href="../psya02/17-lecture.html"><strong aria-hidden="true">1.17.</strong> Clinical Psychology</a></li><li class="expanded "><a href="../psya02/18-lecture.html"><strong aria-hidden="true">1.18.</strong> Clinical Psychology (Part 2)</a></li><li class="expanded "><a href="../psya02/19-lecture.html"><strong aria-hidden="true">1.19.</strong> Clinical Psychology (Part 3)</a></li><li class="expanded "><a href="../psya02/20-lecture.html"><strong aria-hidden="true">1.20.</strong> Therapies</a></li><li class="expanded "><a href="../psya02/21-lecture.html"><strong aria-hidden="true">1.21.</strong> Therapies (Part 2)</a></li><li class="expanded "><a href="../psya02/22-lecture.html"><strong aria-hidden="true">1.22.</strong> Therapies (Part 3)</a></li></ol></li><li class="expanded "><a href="../cscc69/index.html"><strong aria-hidden="true">2.</strong> CSCC69 Operating Systems</a></li><li><ol class="section"><li class="expanded "><a href="../cscc69/intro.html"><strong aria-hidden="true">2.1.</strong> Introduction to Operating Systems</a></li><li class="expanded "><a href="../cscc69/bootstrap.html"><strong aria-hidden="true">2.2.</strong> Bootstrapping</a></li><li class="expanded "><a href="../cscc69/syscalls.html"><strong aria-hidden="true">2.3.</strong> System Calls</a></li><li class="expanded "><a href="../cscc69/sync.html"><strong aria-hidden="true">2.4.</strong> Synchronization</a></li><li><ol class="section"><li class="expanded "><a href="../cscc69/peterson.html"><strong aria-hidden="true">2.4.1.</strong> Peterson's Solution</a></li><li class="expanded "><a href="../cscc69/locks.html"><strong aria-hidden="true">2.4.2.</strong> Locks</a></li><li class="expanded "><a href="../cscc69/semaphores.html"><strong aria-hidden="true">2.4.3.</strong> Semaphores</a></li><li class="expanded "><a href="../cscc69/monitors.html" class="active"><strong aria-hidden="true">2.4.4.</strong> Monitors</a></li></ol></li><li class="expanded "><a href="../cscc69/sched.html"><strong aria-hidden="true">2.5.</strong> Scheduling</a></li><li><ol class="section"><li class="expanded "><a href="../cscc69/non-preemp.html"><strong aria-hidden="true">2.5.1.</strong> Non-preemptive</a></li><li class="expanded "><a href="../cscc69/preemp.html"><strong aria-hidden="true">2.5.2.</strong> Preemptive</a></li></ol></li></ol></li><li class="expanded "><a href="../cscc63/index.html"><strong aria-hidden="true">3.</strong> CSCC63 Computability and Complexity</a></li><li><ol class="section"><li class="expanded "><a href="../cscc63/intro.html"><strong aria-hidden="true">3.1.</strong> Introductions and Definitions</a></li><li><ol class="section"><li class="expanded "><a href="../cscc63/examples/even-ones-tm.html"><strong aria-hidden="true">3.1.1.</strong> Even Ones TM</a></li></ol></li><li class="expanded "><a href="../cscc63/proof-methods.html"><strong aria-hidden="true">3.2.</strong> Proof Methods</a></li><li class="expanded "><a href="../cscc63/turing-machines.html"><strong aria-hidden="true">3.3.</strong> Turing Machines</a></li><li><ol class="section"><li class="expanded "><a href="../cscc63/accept-tm.html"><strong aria-hidden="true">3.3.1.</strong> Accept TM</a></li></ol></li></ol></li></ol>
            </div>
            <div id="sidebar-resize-handle" class="sidebar-resize-handle"></div>
        </nav>

        <div id="page-wrapper" class="page-wrapper">

            <div class="page">
                
                <div id="menu-bar" class="menu-bar">
                    <div id="menu-bar-sticky-container">
                        <div class="left-buttons">
                            <button id="sidebar-toggle" class="icon-button" type="button" title="Toggle Table of Contents" aria-label="Toggle Table of Contents" aria-controls="sidebar">
                                <i class="fa fa-bars"></i>
                            </button>
                            <button id="theme-toggle" class="icon-button" type="button" title="Change theme" aria-label="Change theme" aria-haspopup="true" aria-expanded="false" aria-controls="theme-list">
                                <i class="fa fa-paint-brush"></i>
                            </button>
                            <ul id="theme-list" class="theme-popup" aria-label="Themes" role="menu">
                                <li role="none"><button role="menuitem" class="theme" id="light">Light (default)</button></li>
                                <li role="none"><button role="menuitem" class="theme" id="rust">Rust</button></li>
                                <li role="none"><button role="menuitem" class="theme" id="coal">Coal</button></li>
                                <li role="none"><button role="menuitem" class="theme" id="navy">Navy</button></li>
                                <li role="none"><button role="menuitem" class="theme" id="ayu">Ayu</button></li>
                            </ul>
                            
                            <button id="search-toggle" class="icon-button" type="button" title="Search. (Shortkey: s)" aria-label="Toggle Searchbar" aria-expanded="false" aria-keyshortcuts="S" aria-controls="searchbar">
                                <i class="fa fa-search"></i>
                            </button>
                            
                        </div>

                        <h1 class="menu-title">Notes</h1>

                        <div class="right-buttons">
                            <a href="../print.html" title="Print this book" aria-label="Print this book">
                                <i id="print-button" class="fa fa-print"></i>
                            </a>
                            
                        </div>
                    </div>
                </div>

                
                <div id="search-wrapper" class="hidden">
                    <form id="searchbar-outer" class="searchbar-outer">
                        <input type="search" name="search" id="searchbar" name="searchbar" placeholder="Search this book ..." aria-controls="searchresults-outer" aria-describedby="searchresults-header">
                    </form>
                    <div id="searchresults-outer" class="searchresults-outer hidden">
                        <div id="searchresults-header" class="searchresults-header"></div>
                        <ul id="searchresults">
                        </ul>
                    </div>
                </div>
                

                <!-- Apply ARIA attributes after the sidebar and the sidebar toggle button are added to the DOM -->
                <script type="text/javascript">
                    document.getElementById('sidebar-toggle').setAttribute('aria-expanded', sidebar === 'visible');
                    document.getElementById('sidebar').setAttribute('aria-hidden', sidebar !== 'visible');
                    Array.from(document.querySelectorAll('#sidebar a')).forEach(function(link) {
                        link.setAttribute('tabIndex', sidebar === 'visible' ? 0 : -1);
                    });
                </script>

                <div id="content" class="content">
                    <main>
                        <h1><a class="header" href="#monitors" id="monitors">Monitors</a></h1>
<p>Similar to an <em>abstract data type</em> (data and operations on the data), except only
one process can be active within the monitor at a time</p>
<ul>
<li>local data accessed by monitor's procedures (not by external procedure)</li>
<li>process <em>enters</em> monitor by invoking one of its procedures</li>
<li>other processes attempting to enter monitor are blocked</li>
</ul>
<p>A process in the monitor may need to wait for something to happen:</p>
<ul>
<li>need to allow other process to use the monitor</li>
<li>provide special variable type called a <em>condition</em></li>
<li>operations on <em>condition</em> variable are:
<ul>
<li><strong>wait</strong> (suspend the invoking process)</li>
<li><strong>signal</strong> (resume exactly one suspended process)<br />
if no process is suspended, signal has no effect</li>
</ul>
</li>
</ul>
<p>The benefits of a monitor over semaphores is that locks and conditions are
encapsulated inside a data structure. In java, the <strong>synchronized</strong> keyword
means the lock and unlocking is done for you and guarantees mutual exclusion.</p>
<p><img src="./pictures/monitor.png" alt="monitor" /></p>
<h2><a class="header" href="#monitor-semantics-for-signal" id="monitor-semantics-for-signal">Monitor Semantics for Signal</a></h2>
<ul>
<li>Hoare monitors
<ul>
<li>signal() immediately switches from the caller to a waiting thread</li>
<li>need another queue for signaler, if signaler was not done using the
monitor</li>
</ul>
</li>
<li>Brinch Hansen
<ul>
<li>signaler must exit monitor immediately. signal() always last statement
in the monitor procedure</li>
</ul>
</li>
<li>Mesa monitors
<ul>
<li>signal() places a waiter on ready queue, but signaler continues inside
monitor</li>
</ul>
</li>
</ul>
<h2><a class="header" href="#monitor-banking-example" id="monitor-banking-example">Monitor Banking Example</a></h2>
<p>Threads must acquire the monitor's lock to ensure mutual exclusion</p>
<pre><code class="language-c">Monitor Account {
	int balance;
	pthread_mutex_t lock;
	void withdraw(int amount) {balance -= amount};
	void deposit(int amount) {balance += amount};
}
</code></pre>
<h2><a class="header" href="#monitor-readerwriters-problem" id="monitor-readerwriters-problem">Monitor Reader/Writers Problem</a></h2>
<pre><code class="language-c">typedef struct file_s {
	int readcount;
	pthread_cond_t read;
	pthread_cond_t write;
	pthread_mutex_t lock;
} file_t;

/* Initialize values */
file_t file;

void read_file() {
	file.readcount++;
	pthread_mutex_lock(file.lock);
	read;
	file.readcount--;
	pthread_mutex_release(file.lock);

	if (file.readcount == 0) {
		pthread_cond_signal(file.write);
	}
	else {
		pthread_cond_signal(file.read);
	}
}

void write_to_file() {
	pthread_mutex_lock(file.lock);
	while(readcount &gt; 0) {
		pthread_wait_cond(file.write, file.lock);
	}
	write;
	pthread_mutex_release(file.lock);
	pthread_cond_signal(file.write);
	pthread_cond_signal(file.read);
}
</code></pre>
<h2><a class="header" href="#monitor-bounded-buffer-example" id="monitor-bounded-buffer-example">Monitor Bounded Buffer Example</a></h2>
<p>We want to use a monitor to control access to a size N buffer. As well as a lock,
we need two conditions:</p>
<ul>
<li>Producers need the buffer to be not full</li>
<li>Consumers need the buffer to be not empty</li>
</ul>
<pre><code class="language-c">#define N 100
typedef struct buf_s {
	int data[N];
	int inpos;
	int outpos;
	int numelements;
	pthread_cond_t notFull;
	pthread_cond_t notEmpty;
	pthread_mutex_t lock;
} buf_t;

/* Initialize values */
buf_t buf;

void add_to_buff(int value) {
	pthread_mutex_lock(buf.lock);

	while (buf.numelements == N) {
		// buffer is full, wait
		pthread_cond_wait(buf.notFull, buf.mylock);
	}
	buf.data[buf.inpos] = value;
	buf.inpos = (buf.inpos + 1) % N;
	buf.numelements++;

	pthread_cond_signal(buf.notEmpty);
	
	pthread_mutex_release(buf.lock);
}

int remove_from_buff() {
	int val;
	pthread_mutex_lock(buf.lock);
	
	while (buf.numelements == 0) {
		// buffer is empty, wait
		pthread_cond_wait(buf.notEmpty, buf.lock);
	}
	val = buf.data[buf.outpos];
	buf.outpos = (buf.outpos + 1) % N;
	buf.numelements--;

	pthread_cond_signal(buf.notFull);

	pthread_mutex_release(buf.lock);
	return val;
}
</code></pre>
<p>Note that when a process waits on a condition and is signalled, it is only a hint
that the condition is true but not a guarantee once it enters the monitor.
Another process could change the value while the process is queuing up. That's
why the while loop is needed, so the buffer goes back to the waiting queue if the
condition is not satisfied.</p>

                    </main>

                    <nav class="nav-wrapper" aria-label="Page navigation">
                        <!-- Mobile navigation buttons -->
                        
                            <a rel="prev" href="../cscc69/semaphores.html" class="mobile-nav-chapters previous" title="Previous chapter" aria-label="Previous chapter" aria-keyshortcuts="Left">
                                <i class="fa fa-angle-left"></i>
                            </a>
                        

                        
                            <a rel="next" href="../cscc69/sched.html" class="mobile-nav-chapters next" title="Next chapter" aria-label="Next chapter" aria-keyshortcuts="Right">
                                <i class="fa fa-angle-right"></i>
                            </a>
                        

                        <div style="clear: both"></div>
                    </nav>
                </div>
            </div>

            <nav class="nav-wide-wrapper" aria-label="Page navigation">
                
                    <a href="../cscc69/semaphores.html" class="nav-chapters previous" title="Previous chapter" aria-label="Previous chapter" aria-keyshortcuts="Left">
                        <i class="fa fa-angle-left"></i>
                    </a>
                

                
                    <a href="../cscc69/sched.html" class="nav-chapters next" title="Next chapter" aria-label="Next chapter" aria-keyshortcuts="Right">
                        <i class="fa fa-angle-right"></i>
                    </a>
                
            </nav>

        </div>

        

        

        
        
        
        <script type="text/javascript">
            window.playpen_copyable = true;
        </script>
        

        

        
        <script src="../elasticlunr.min.js" type="text/javascript" charset="utf-8"></script>
        <script src="../mark.min.js" type="text/javascript" charset="utf-8"></script>
        <script src="../searcher.js" type="text/javascript" charset="utf-8"></script>
        

        <script src="../clipboard.min.js" type="text/javascript" charset="utf-8"></script>
        <script src="../highlight.js" type="text/javascript" charset="utf-8"></script>
        <script src="../book.js" type="text/javascript" charset="utf-8"></script>

        <!-- Custom JS scripts -->
        

        

    </body>
</html>
